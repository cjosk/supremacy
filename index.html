<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Supremacy Guild Paneli</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet.js CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Supabase.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray Background */
        }
        .table-container::-webkit-scrollbar, .battle-list::-webkit-scrollbar, .kill-list::-webkit-scrollbar, .alert-list::-webkit-scrollbar, .battle-report-players::-webkit-scrollbar, #role-sidebar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track, .battle-list::-webkit-scrollbar-track, .kill-list::-webkit-scrollbar-track, .alert-list::-webkit-scrollbar-track, .battle-report-players::-webkit-scrollbar-track, #role-sidebar::-webkit-scrollbar-track {
            background: #1F2937;
        }
        .table-container::-webkit-scrollbar-thumb, .battle-list::-webkit-scrollbar-thumb, .kill-list::-webkit-scrollbar-thumb, .alert-list::-webkit-scrollbar-thumb, .battle-report-players::-webkit-scrollbar-thumb, #role-sidebar::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #EF4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-btn { 
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active { 
            background-color: #DC2626; 
            color: white; 
        }
        #player-modal, #composition-modal { backdrop-filter: blur(5px); }
        .card {
            background-color: #1f2937; /* Gray 800 */
            border: 1px solid #374151; /* Gray 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .comp-grid-cell {
            background-color: rgba(255,255,255,0.05);
            border: 1px dashed #4b5563;
            min-height: 2.5rem; /* 40px */
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            padding: 0.25rem;
        }
        .comp-grid-cell.drag-over {
            background-color: rgba(220, 38, 38, 0.3);
            border-style: solid;
        }
        .role-item {
            cursor: grab;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .role-item:active {
            cursor: grabbing;
        }
        #leaflet-map {
            height: 600px;
            background-color: #0c1018;
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen antialiased">

    <!-- GiriÅŸ EkranÄ± -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center p-4">
        <img src="https://i.hizliresim.com/pu29soc.png" alt="Team Supremacy Logo" class="h-20 w-auto mb-6">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
            <h2 class="text-center text-2xl font-bold text-white mb-4">Panele GiriÅŸ Yap</h2>
            <p class="text-center text-sm text-gray-400 mb-6">LÃ¼tfen guild ÅŸifresini girin.</p>
            <input type="password" id="password-input" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 text-center focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button id="login-button" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">GiriÅŸ Yap</button>
            <p id="login-error" class="text-red-400 text-center text-sm mt-4 h-4"></p>
        </div>
    </div>

    <!-- Ana Panel Ä°Ã§eriÄŸi (BaÅŸlangÄ±Ã§ta gizli) -->
    <div id="main-panel" class="hidden">
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://i.hizliresim.com/pu29soc.png" alt="Team Supremacy Logo" class="h-12 w-auto">
                        <h1 class="text-xl font-bold text-white tracking-tight">Team Supremacy</h1>
                    </div>
                    <nav class="flex space-x-1 bg-gray-900/50 border border-gray-700 p-1.5 rounded-xl">
                        <button id="nav-dashboard" class="nav-btn active py-2 px-4 rounded-lg text-sm font-semibold">Genel BakÄ±ÅŸ</button>
                        <button id="nav-members" class="nav-btn py-2 px-4 rounded-lg text-sm font-semibold text-gray-400">Ãœye Listesi</button>
                        <button id="nav-battles" class="nav-btn py-2 px-4 rounded-lg text-sm font-semibold text-gray-400">SavaÅŸlar</button>
                        <button id="nav-composition" class="nav-btn py-2 px-4 rounded-lg text-sm font-semibold text-gray-400">MaÃ§ Kompozisyonu</button>
                        <button id="nav-analysis" class="nav-btn py-2 px-4 rounded-lg text-sm font-semibold text-gray-400">Rakip Analizi</button>
                        <button id="nav-tracking" class="nav-btn py-2 px-4 rounded-lg text-sm font-semibold text-gray-400">ðŸ”” Takip</button>
                    </nav>
                </div>
            </div>
        </header>

        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="status-container" class="flex justify-center items-center my-8 h-24">
                <div id="loader" class="loader"></div>
                <div id="status-message" class="text-center text-lg text-gray-400"></div>
            </div>
            <main id="content-container" class="hidden opacity-0 transition-opacity duration-500">
                <!-- DASHBOARD SAYFASI -->
                <div id="dashboard-page">
                    <div id="guild-stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div id="top-contributors" class="card lg:col-span-1"></div>
                        <div class="card lg:col-span-1 flex flex-col">
                            <h3 class="text-lg font-bold text-red-400 mb-4 flex-shrink-0">Genel Fame DaÄŸÄ±lÄ±mÄ±</h3>
                            <div class="relative flex-grow w-full h-full min-h-[250px]">
                                <canvas id="fame-chart"></canvas>
                            </div>
                        </div>
                        <div id="top-pvp" class="card lg:col-span-1"></div>
                    </div>
                    <div class="card">
                         <h2 class="text-2xl font-bold mb-4 text-center text-red-400">DÃ¼nya HaritasÄ±</h2>
                        <div id="leaflet-map" class="rounded-lg overflow-hidden border border-gray-700"></div>
                    </div>
                </div>
                <!-- DÄ°ÄžER SAYFALAR... -->
                <div id="members-page" class="hidden card">
                    <h2 class="text-2xl font-bold mb-4 text-center text-red-400">Guild Ãœye Listesi</h2>
                    <div class="table-container overflow-x-auto">
                        <table class="min-w-full">
                             <thead class="bg-gray-900/70">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">Oyuncu AdÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Kill Fame</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Death Fame</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">PvE Fame</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Gathering Fame</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Crafting Fame</th>
                                </tr>
                            </thead>
                            <tbody id="member-list-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="battles-page" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-red-400">Son AyÄ±n SavaÅŸlarÄ±</h2>
                                <div class="flex items-center gap-2">
                                    <label for="battle-filter-input" class="text-sm text-gray-400">Min. KatÄ±lÄ±mcÄ±:</label>
                                    <input type="number" id="battle-filter-input" value="0" min="0" class="bg-gray-900 text-white w-20 text-center rounded-md border border-gray-600 focus:ring-red-500 focus:border-red-500">
                                </div>
                            </div>
                            <div id="battles-list-container" class="battle-list space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                        </div>
                        <div id="battle-report-container" class="lg:col-span-2 card">
                            <div class="flex items-center justify-center h-full text-gray-400">DetaylarÄ± gÃ¶rmek iÃ§in bir savaÅŸ seÃ§in.</div>
                        </div>
                    </div>
                </div>
                 <div id="composition-page" class="hidden card">
                    <h2 class="text-2xl font-bold mb-4 text-center text-red-400">ZvZ Kompozisyon PlanlayÄ±cÄ±</h2>
                    <div class="flex justify-end gap-2 mb-4">
                        <button id="save-comp-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Kompozisyonu Kaydet</button>
                        <button id="load-comp-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">KayÄ±tlÄ± Kompozisyonlar</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div id="role-sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-gray-900/50 p-4 rounded-lg border border-gray-700 flex-shrink-0 space-y-4 overflow-y-auto max-h-[70vh]">
                           <!-- Roller buraya eklenecek -->
                        </div>
                        <div class="flex-grow flex flex-col md:flex-row gap-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-white mb-2 text-center">Birinci Grup</h3>
                                <div id="composition-grid-1" class="bg-gray-900/50 p-2 rounded-lg border border-gray-700 grid grid-cols-1 gap-2">
                                    <!-- 20 hÃ¼cre buraya eklenecek -->
                                </div>
                            </div>
                             <div class="flex-1">
                                <h3 class="font-bold text-white mb-2 text-center">Ä°kinci Grup</h3>
                                <div id="composition-grid-2" class="bg-gray-900/50 p-2 rounded-lg border border-gray-700 grid grid-cols-1 gap-2">
                                    <!-- 20 hÃ¼cre buraya eklenecek -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-bold text-white mb-2">Rol DaÄŸÄ±lÄ±mÄ±</h3>
                        <div id="comp-progress-bar" class="w-full bg-gray-700 rounded-full h-6 flex text-xs font-medium text-white text-center">
                            <!-- Progress bar segmentleri buraya gelecek -->
                        </div>
                    </div>
                </div>
                <div id="analysis-page" class="hidden card">
                    <h2 class="text-2xl font-bold mb-4 text-center text-red-400">Rakip Analizi</h2>
                    <div class="max-w-xl mx-auto">
                        <div class="flex gap-2">
                            <input type="text" id="search-input" class="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="Guild veya Oyuncu AdÄ± Girin...">
                            <button id="search-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition">Ara</button>
                        </div>
                    </div>
                    <div id="search-results" class="mt-8">
                        <!-- Arama sonuÃ§larÄ± buraya gelecek -->
                    </div>
                </div>
                <div id="tracking-page" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-lg font-bold text-yellow-500 mb-3">Ä°naktif Oyuncular (7+ gÃ¼n)</h3>
                            <p class="text-sm text-gray-400 mb-4">7 gÃ¼nden uzun sÃ¼redir kill veya death kaydÄ± olmayan oyuncular. Bu analiz tÃ¼m Ã¼yeleri kontrol ettiÄŸi iÃ§in biraz zaman alabilir.</p>
                            <button id="inactive-check-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">Analizi BaÅŸlat</button>
                            <div id="inactive-list-container" class="mt-4"></div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-bold text-orange-500 mb-3">Riskli Oyuncular</h3>
                            <p class="text-sm text-gray-400 mb-4">Son aydaki savaÅŸlarda Ã¶len guild Ã¼yeleri.</p>
                            <div id="risky-list-container" class="mt-4 alert-list max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>
                     <div class="mt-6 card">
                        <h3 class="text-lg font-bold text-blue-400 mb-3">Takip Listesi Notu</h3>
                        <p class="text-sm text-gray-400">"Fame artÄ±ÅŸÄ± duraksayanlar" Ã¶zelliÄŸinin eklenebilmesi iÃ§in Albion Online API'sinin geÃ§miÅŸe dÃ¶nÃ¼k fame verilerini saÄŸlamasÄ± gerekmektedir. Mevcut API bu imkanÄ± sunmadÄ±ÄŸÄ± iÃ§in bu Ã¶zellik ÅŸu an iÃ§in eklenememektedir.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="player-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content" class="bg-gray-800 border-gray-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="modal-player-name" class="text-2xl font-bold text-white"></h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-gray-900/50"></div>
        </div>
    </div>
    <div id="composition-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
         <div class="bg-gray-800 border-gray-700 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-white">KayÄ±tlÄ± Kompozisyonlar</h2>
                <button id="comp-modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="comp-modal-body" class="p-6 max-h-[60vh] overflow-y-auto">
                <!-- KayÄ±tlÄ± kompozisyonlar buraya gelecek -->
            </div>
        </div>
    </div>

    <script>
        // --- Supabase Client Kurulumu ---
        const supabaseUrl = 'https://pzqhhoenqdipqhzeeces.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6cWhob2VucWRpcHFoemVlY2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTk2MzAsImV4cCI6MjA3MTEzNTYzMH0.6Q78bfMf7A0RwbhDigBk6wDMhk815u4NU9ucejX6UG0';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- GLOBAL DEÄžÄ°ÅžKENLER ---
        let guildMembersData = [];
        let allGuildBattles = [];
        let battlesLoaded = false;
        let fameChartInstance = null;
        let compositionBuilderInitialized = false;
        let leafletMap = null;
        
        // --- DOM ELEMENTLERÄ° ---
        const loginOverlay = document.getElementById('login-overlay');
        const mainPanel = document.getElementById('main-panel');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        
        const statusContainer = document.getElementById('status-container');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('status-message');
        const contentContainer = document.getElementById('content-container');
        const guildStatsCards = document.getElementById('guild-stats-cards');
        const memberListBody = document.getElementById('member-list-body');
        const navDashboard = document.getElementById('nav-dashboard');
        const navMembers = document.getElementById('nav-members');
        const navBattles = document.getElementById('nav-battles');
        const navComposition = document.getElementById('nav-composition');
        const navAnalysis = document.getElementById('nav-analysis');
        const navTracking = document.getElementById('nav-tracking');
        const dashboardPage = document.getElementById('dashboard-page');
        const membersPage = document.getElementById('members-page');
        const battlesPage = document.getElementById('battles-page');
        const compositionPage = document.getElementById('composition-page');
        const analysisPage = document.getElementById('analysis-page');
        const trackingPage = document.getElementById('tracking-page');
        const battlesListContainer = document.getElementById('battles-list-container');
        const battleReportContainer = document.getElementById('battle-report-container');
        const battleFilterInput = document.getElementById('battle-filter-input');
        const playerModal = document.getElementById('player-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalPlayerName = document.getElementById('modal-player-name');
        const modalBody = document.getElementById('modal-body');
        const inactiveCheckBtn = document.getElementById('inactive-check-btn');
        const inactiveListContainer = document.getElementById('inactive-list-container');
        const riskyListContainer = document.getElementById('risky-list-container');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsContainer = document.getElementById('search-results');

        // --- SABÄ°TLER ---
        const GUILD_ID = 'MsXlz1fUQFySJSqG4HiGbA';
        const RENDER_URL = 'https://render.albiononline.com/v1/item/';
        const BASE_URL = 'https://gameinfo-ams.albiononline.com/api/gameinfo';
        const PROXY_URL = 'https://proxy.cors.sh/';
        const API_KEY = 'temp_ff0746eb80e70d5acdaaa0c947a7c1f4';
        const HEADERS = { 'x-cors-api-key': API_KEY };
        const DISARRAY_MAP = { 1: 21, 2: 22, 3: 23, 4: 24, 5: 25, 6: 26, 7: 27, 8: 28, 9: 29, 10: 30, 11: 31, 12: 32, 13: 33, 14: 34, 15: 36, 16: 37, 17: 39, 18: 41, 19: 44, 20: 46, 21: 48, 22: 49, 23: 51, 24: 54, 25: 56, 26: 58, 27: 61, 28: 64, 29: 67, 30: 70, 31: 74, 32: 79, 33: 83, 34: 89, 35: 95, 36: 99, 37: 103, 38: 108, 39: 114, 40: 119, 41: 126, 42: 133, 43: 141, 44: 148, 45: 154, 46: 160, 47: 167, 48: 175, 49: 183, 50: 192, 51: 200, 52: 207, 53: 215, 54: 223, 55: 232, 56: 242, 57: 252, 58: 264, 59: 276, 60: 290, 61: 305, 62: 322, 63: 341, 64: 361, 65: 385, 66: 412, 67: 445 };

        // --- YARDIMCI FONKSÄ°YONLAR ---
        function formatFame(value) {
            if (!value) return '0';
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'm';
            }
            if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'k';
            }
            return value.toString();
        }

        function getDisarrayLevel(playerCount) {
            if (playerCount < 21) return 0;
            for (const level in DISARRAY_MAP) {
                if (playerCount <= DISARRAY_MAP[level]) {
                    return level;
                }
            }
            return 67; // Max level
        }

        function analyzeEquipment(kills) {
            const equipmentSlots = ['MainHand', 'OffHand', 'Head', 'Armor', 'Shoes', 'Cape'];
            const equipmentCount = {};
            kills.forEach(kill => {
                if (kill.Killer.Equipment) {
                    equipmentSlots.forEach(slot => {
                        const item = kill.Killer.Equipment[slot];
                        if (item) {
                            if (!equipmentCount[slot]) equipmentCount[slot] = {};
                            equipmentCount[slot][item.Type] = (equipmentCount[slot][item.Type] || 0) + 1;
                        }
                    });
                }
            });
            const topEquipment = {};
            equipmentSlots.forEach(slot => {
                if (equipmentCount[slot]) {
                    const topItem = Object.entries(equipmentCount[slot]).sort((a, b) => b[1] - a[1])[0];
                    topEquipment[slot] = { Type: topItem[0] };
                }
            });
            return topEquipment;
        }

        function createEventHtml(event, type) {
            const isKill = type === 'kill';
            const target = isKill ? event.Victim : event.Killer;
            const fame = event.KillFame || 0;
            const targetName = target.Name;
            const targetGuild = target.GuildName;
            const item = isKill ? event.Victim?.Equipment?.MainHand : event.Killer?.Equipment?.MainHand;
            return `<li class="flex items-center justify-between bg-gray-700/50 p-2 rounded-md text-sm"><div class="flex items-center gap-3">${item ? `<img src="${RENDER_URL}${item.Type}.png" class="w-8 h-8 rounded bg-gray-800">` : '<div class="w-8 h-8 rounded bg-gray-800"></div>'}<div><p class="font-semibold text-white">${targetName}</p><p class="text-xs text-gray-400">[${targetGuild}]</p></div></div><span class="font-bold ${isKill ? 'text-green-400' : 'text-red-400'}">${formatFame(fame)} Fame</span></li>`;
        }
        
        // --- UYGULAMA BAÅžLATMA ---
        window.addEventListener('load', setupLogin);

        function setupLogin() {
            loginButton.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
        }

        function checkPassword() {
            const CORRECT_PASSWORD = 'supremacy'; 
            if (passwordInput.value === CORRECT_PASSWORD) {
                loginOverlay.classList.add('hidden');
                mainPanel.classList.remove('hidden');
                initializeApp();
            } else {
                loginError.textContent = 'HatalÄ± ÅŸifre. LÃ¼tfen tekrar deneyin.';
                passwordInput.value = '';
            }
        }

        async function initializeApp() {
            setupNavigation();
            setupModal();
            showStatus('Guild verileri yÃ¼kleniyor...', 'loading');
            try {
                const { data: members, error } = await supabaseClient
                    .from('players')
                    .select(`
                        player_id,
                        player_name,
                        guild_members!inner(guild_id),
                        fame_history(pvp_fame, pve_fame, gather_fame, craft_fame)
                    `)
                    .eq('guild_members.is_active', true)
                    .eq('guild_members.guild_id', GUILD_ID)
                    .order('created_at', { foreignTable: 'fame_history', ascending: false })
                    .limit(1, { foreignTable: 'fame_history' });

                if (error) throw error;

                guildMembersData = members.map(player => ({
                    Id: player.player_id,
                    Name: player.player_name,
                    KillFame: player.fame_history[0]?.pvp_fame || 0,
                    DeathFame: 0,
                    LifetimeStatistics: {
                        PvE: { Total: player.fame_history[0]?.pve_fame || 0 },
                        Gathering: { All: { Total: player.fame_history[0]?.gather_fame || 0 } },
                        Crafting: { Total: player.fame_history[0]?.craft_fame || 0 }
                    }
                }));
                
                const guildDetails = { Name: "Team Supremacy", MemberCount: guildMembersData.length };

                displayGuildInfo(guildDetails, guildMembersData);
                displayDashboard(guildMembersData);
                displayMembers(guildMembersData);
                
                displayBattleList([]); 
                displayTrackingDashboard(guildMembersData, []);

                statusContainer.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                setTimeout(() => contentContainer.classList.remove('opacity-0'), 50);

            } catch (error) {
                console.error('Veri Ã§ekme hatasÄ±:', error);
                showStatus('VeritabanÄ±ndan lonca bilgileri getirilemedi.', 'error');
            }
        }

        // --- API Ä°STEK FONKSÄ°YONLARI ---
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        async function fetchApi(endpoint, retries = 3) {
            for (let i = 0; i < retries; i++) {
                const response = await fetch(`${PROXY_URL}${BASE_URL}${endpoint}`, { headers: HEADERS });
                if (response.status === 429 || response.status === 503) {
                    console.warn(`Rate limit hit for ${endpoint}. Retrying in ${i + 1}s...`);
                    await sleep(1000 * (i + 1));
                    continue;
                }
                if (!response.ok) throw new Error(`API isteÄŸi baÅŸarÄ±sÄ±z: ${endpoint} (Status: ${response.status})`);
                return response.json();
            }
            throw new Error(`API isteÄŸi ${retries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${endpoint}`);
        }
        
        // ... DiÄŸer tÃ¼m JavaScript fonksiyonlarÄ± aynÄ± kalacak ...
        async function fetchAllBattles(range = 'month', limit = 51) {
            let allBattles = [];
            let offset = 0;
            while (true) {
                const page = await fetchApi(`/battles?range=${range}&sort=recent&limit=${limit}&offset=${offset}`);
                if (!page || page.length === 0) break; 
                allBattles = allBattles.concat(page);
                if (page.length < limit) break;
                offset += limit;
                if (offset >= 2000) break;
                await sleep(200); 
            }
            return allBattles;
        }
        async function loadBattleDataIfNeeded() {
            if (battlesLoaded) return; 

            battlesLoaded = true; 
            const originalBattleText = battlesListContainer.innerHTML;
            const originalRiskyText = riskyListContainer.innerHTML;
            battlesListContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            riskyListContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            
            try {
                const { data: battles, error } = await supabaseClient
                    .from('battles')
                    .select('*')
                    .order('start_time', { ascending: false })
                    .limit(100);

                if (error) throw error;

                allGuildBattles = battles; 
                displayBattleList(allGuildBattles);
                displayTrackingDashboard(guildMembersData, allGuildBattles);
            } catch (error) {
                console.error("SavaÅŸ verileri Ã§ekilemedi:", error);
                battlesListContainer.innerHTML = `<p class="text-red-400 text-center">SavaÅŸ verileri yÃ¼klenemedi.</p>`;
                battlesLoaded = false;
            }
        }
        function setupNavigation() {
            navDashboard.addEventListener('click', () => showPage('dashboard'));
            navMembers.addEventListener('click', () => showPage('members'));
            navBattles.addEventListener('click', () => {
                showPage('battles');
                loadBattleDataIfNeeded();
            });
            navComposition.addEventListener('click', () => {
                showPage('composition');
                if (!compositionBuilderInitialized) {
                    setupCompositionBuilder();
                    compositionBuilderInitialized = true;
                }
            });
            navAnalysis.addEventListener('click', () => showPage('analysis'));
            navTracking.addEventListener('click', () => {
                showPage('tracking');
                loadBattleDataIfNeeded();
            });
            inactiveCheckBtn.addEventListener('click', startInactiveAnalysis);
            battleFilterInput.addEventListener('input', applyBattleFilter);
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
        }
        function setupModal() {
            modalCloseBtn.addEventListener('click', () => playerModal.classList.add('hidden'));
            playerModal.addEventListener('click', (e) => { if (e.target === playerModal) playerModal.classList.add('hidden'); });
        }
        function showPage(pageName) {
            const pages = { dashboard: dashboardPage, members: membersPage, battles: battlesPage, composition: compositionPage, analysis: analysisPage, tracking: trackingPage };
            const navs = { dashboard: navDashboard, members: navMembers, battles: navBattles, composition: navComposition, analysis: navAnalysis, tracking: navTracking };
            for (const page in pages) {
                pages[page].classList.toggle('hidden', page !== pageName);
                navs[page].classList.toggle('active', page === pageName);
            }
        }
        window.showPlayerProfile = async function(playerId) {
            modalPlayerName.textContent = 'YÃ¼kleniyor...';
            playerModal.classList.remove('hidden');
            modalBody.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>';
            try {
                const [playerData, kills, deaths] = await Promise.all([
                    fetchApi(`/players/${playerId}`),
                    fetchApi(`/players/${playerId}/kills`),
                    fetchApi(`/players/${playerId}/deaths`)
                ]);
                modalPlayerName.textContent = playerData.Name;
                const equipment = analyzeEquipment(kills);
                const kdRatio = playerData.DeathFame === 0 ? playerData.KillFame : (playerData.KillFame / playerData.DeathFame);
                const pveRatio = playerData.FameRatio;
                const ls = playerData.LifetimeStatistics;
                modalBody.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="space-y-6"><div class="card"><h3 class="text-lg font-bold text-red-400 mb-3">Genel Bilgiler</h3><div class="grid grid-cols-2 gap-2 text-sm"><span class="text-gray-400">Guild:</span> <span class="font-semibold">${playerData.GuildName}</span><span class="text-gray-400">Ä°ttifak:</span> <span class="font-semibold">${playerData.AllianceName}</span><span class="text-gray-400">K/D OranÄ±:</span> <span class="font-semibold">${kdRatio.toFixed(2)}</span><span class="text-gray-400">Fame OranÄ±:</span> <span class="font-semibold">${pveRatio.toFixed(2)}</span></div></div><div class="card"><h3 class="text-lg font-bold text-red-400 mb-3">Fame Ä°statistikleri</h3><div class="grid grid-cols-2 gap-2 text-sm"><span class="text-gray-400">Toplam Fame:</span> <span class="font-semibold">${formatFame(playerData.KillFame + (ls.PvE?.Total || 0))}</span><span class="text-gray-400">Kill Fame:</span> <span class="font-semibold">${formatFame(playerData.KillFame)}</span><span class="text-gray-400">Death Fame:</span> <span class="font-semibold">${formatFame(playerData.DeathFame)}</span><span class="text-gray-400">PvE Fame:</span> <span class="font-semibold">${formatFame(ls.PvE?.Total || 0)}</span></div></div><div class="card"><h3 class="text-lg font-bold text-red-400 mb-3">SÄ±k KullanÄ±lanlar</h3><div class="flex flex-wrap gap-2">${Object.entries(equipment).map(([slot, item]) => item ? `<img src="${RENDER_URL}${item.Type}.png?quality=3" alt="${item.Type}" class="w-12 h-12 bg-gray-900 rounded-md border border-gray-600" title="${slot}">` : '').join('')}</div></div></div><div class="space-y-6"><div class="card"><h3 class="text-lg font-bold text-red-400 mb-3">Aktiviteye GÃ¶re Fame</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm"><span class="text-gray-400">Royal:</span> <span class="font-semibold">${formatFame(ls.PvE?.Royal || 0)}</span><span class="text-gray-400">Outlands:</span> <span class="font-semibold">${formatFame(ls.PvE?.Outlands || 0)}</span><span class="text-gray-400">Avalon:</span> <span class="font-semibold">${formatFame(ls.PvE?.Avalon || 0)}</span><span class="text-gray-400">Hellgate:</span> <span class="font-semibold">${formatFame(ls.Hellgate?.Total || 0)}</span><span class="text-gray-400">Corrupted:</span> <span class="font-semibold">${formatFame(ls.PvE?.CorruptedDungeon || 0)}</span><span class="text-gray-400">Toplama:</span> <span class="font-semibold">${formatFame(ls.Gathering?.All?.Total || 0)}</span><span class="text-gray-400">Ãœretim:</span> <span class="font-semibold">${formatFame(ls.Crafting?.Total || 0)}</span><span class="text-gray-400">BalÄ±kÃ§Ä±lÄ±k:</span> <span class="font-semibold">${formatFame(ls.FishingFame || 0)}</span></div></div><div><h3 class="text-lg font-bold text-green-400 mb-2">Son Kills</h3><ul class="kill-list space-y-2 max-h-48 overflow-y-auto pr-2">${kills.length > 0 ? kills.slice(0,10).map(k => createEventHtml(k, 'kill')).join('') : '<li class="text-gray-400">KayÄ±t bulunamadÄ±.</li>'}</ul></div><div><h3 class="text-lg font-bold text-red-400 mb-2">Son Deaths</h3><ul class="kill-list space-y-2 max-h-48 overflow-y-auto pr-2">${deaths.length > 0 ? deaths.slice(0,10).map(d => createEventHtml(d, 'death')).join('') : '<li class="text-gray-400">KayÄ±t bulunamadÄ±.</li>'}</ul></div></div></div>`;
            } catch (error) {
                console.error("Profil verisi Ã§ekilemedi:", error);
                modalBody.innerHTML = '<p class="text-red-400 text-center">Oyuncu profili yÃ¼klenemedi.</p>';
            }
        }
        window.showBattleReport = async function(battleId) {
            battleReportContainer.innerHTML = '<div class="flex items-center justify-center h-full"><div class="loader"></div></div>';
            try {
                const report = await fetchApi(`/battles/${battleId}`);
                
                const mvp = Object.values(report.players).sort((a,b) => b.killFame - a.killFame)[0];
                const duration = (new Date(report.endTime) - new Date(report.startTime)) / 60000; // dakika

                let guilds = {};
                for (const player of Object.values(report.players)) {
                    if (!guilds[player.guildId]) {
                        guilds[player.guildId] = {
                            name: player.guildName || 'BaÄŸÄ±msÄ±z',
                            id: player.guildId,
                            kills: 0,
                            deaths: 0,
                            fame: 0,
                            players: []
                        };
                    }
                    guilds[player.guildId].kills += player.kills;
                    guilds[player.guildId].deaths += player.deaths;
                    guilds[player.guildId].fame += player.killFame;
                    guilds[player.guildId].players.push(player);
                }
                const sortedGuilds = Object.values(guilds).sort((a,b) => b.fame - a.fame);

                battleReportContainer.innerHTML = `
                    <h3 class="text-2xl font-bold text-center text-red-400 mb-4">SavaÅŸ Raporu #${report.id}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">Toplam Kill</div>
                            <div class="text-xl font-bold">${report.totalKills}</div>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">Toplam Fame</div>
                            <div class="text-xl font-bold">${formatFame(report.totalFame)}</div>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">SÃ¼re</div>
                            <div class="text-xl font-bold">${duration.toFixed(0)} dk</div>
                        </div>
                    </div>
                    <div class="card mb-6">
                        <h4 class="text-lg font-bold text-yellow-400 mb-2 text-center">SavaÅŸÄ±n MVP'si</h4>
                        <p class="text-center text-2xl font-bold">${mvp.name}</p>
                        <p class="text-center text-gray-400 text-sm">[${mvp.guildName}]</p>
                        <div class="flex justify-center gap-6 mt-2 text-sm">
                            <span><span class="font-bold text-green-400">${mvp.kills}</span> Kill</span>
                            <span><span class="font-bold text-red-400">${mvp.deaths}</span> Death</span>
                            <span><span class="font-bold text-yellow-400">${formatFame(mvp.killFame)}</span> Fame</span>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="text-lg font-bold text-red-400 mb-3">SavaÅŸ Ä°statistikleri</h4>
                        <div class="table-container overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-900/70">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Guild</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Kills</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Deaths</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Fame</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700">
                                    ${sortedGuilds.map(g => `
                                        <tr>
                                            <td class="px-4 py-2 whitespace-nowrap"><span class="font-semibold ${g.id === GUILD_ID ? 'text-red-400' : ''}">${g.name}</span> <span class="text-gray-400 text-xs">(${g.players.length} kiÅŸi / Lvl ${getDisarrayLevel(g.players.length)})</span></td>
                                            <td class="px-4 py-2 text-center text-green-400 font-semibold">${g.kills}</td>
                                            <td class="px-4 py-2 text-center text-red-400 font-semibold">${g.deaths}</td>
                                            <td class="px-4 py-2 text-right font-semibold">${formatFame(g.fame)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error("SavaÅŸ raporu Ã§ekilemedi:", error);
                battleReportContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-400">SavaÅŸ raporu yÃ¼klenemedi.</div>';
            }
        }
        
        function displayGuildInfo(guild, members) {
            const totalKillFame = members.reduce((sum, m) => sum + m.KillFame, 0);
            const totalDeathFame = members.reduce((sum, m) => sum + m.DeathFame, 0);
            const totalPveFame = members.reduce((sum, m) => sum + (m.LifetimeStatistics.PvE.Total || 0), 0);

            const createStatCard = (title, value, icon) => `
                <div class="card">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-600/20 text-red-400 mr-4">${icon}</div>
                        <div>
                            <p class="text-sm font-medium text-gray-400">${title}</p>
                            <p class="text-2xl font-bold text-white">${value}</p>
                        </div>
                    </div>
                </div>`;
            
            guildStatsCards.innerHTML = `
                ${createStatCard('Ãœye SayÄ±sÄ±', guild.MemberCount, '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>')}
                ${createStatCard('Toplam Kill Fame', formatFame(totalKillFame), '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.121 14.121L19 19m-7-7l4.879-4.879M12 12L7.121 7.121m7.071 7.071L7.121 19M3 12h18" /></svg>')}
                ${createStatCard('Toplam Death Fame', formatFame(totalDeathFame), '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>')}
                ${createStatCard('Toplam PvE Fame', formatFame(totalPveFame), '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>')}
            `;
        }
        function displayDashboard(members) {
            const sortedByTotalFame = [...members].map(m => ({...m, TotalFame: m.KillFame + (m.LifetimeStatistics.PvE.Total || 0) + (m.LifetimeStatistics.Gathering.All.Total || 0) + (m.LifetimeStatistics.Crafting.Total || 0)})).sort((a, b) => b.TotalFame - a.TotalFame);
            createTopPlayerCard('top-contributors', 'En Ã‡ok Fame\'e Sahip Oyuncular', sortedByTotalFame, m => m.TotalFame);
            createTopPlayerCard('top-pvp', 'En Ã‡ok Kill Alanlar (Fame)', [...members].sort((a, b) => b.KillFame - a.KillFame), m => m.KillFame);
            
            const totalKillFame = members.reduce((sum, m) => sum + m.KillFame, 0);
            const totalPveFame = members.reduce((sum, m) => sum + (m.LifetimeStatistics.PvE.Total || 0), 0);
            const totalGatheringFame = members.reduce((sum, m) => sum + (m.LifetimeStatistics.Gathering.All.Total || 0), 0);
            
            const ctx = document.getElementById('fame-chart').getContext('2d');
            if(fameChartInstance) fameChartInstance.destroy();
            fameChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['PvP Fame', 'PvE Fame', 'Toplama Fame'],
                    datasets: [{
                        data: [totalKillFame, totalPveFame, totalGatheringFame],
                        backgroundColor: ['#DC2626', '#2563EB', '#059669'],
                        borderColor: '#1f2937',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#d1d5db',
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        }
                    }
                }
            });
        }
        function createTopPlayerCard(elementId, title, sortedMembers, valueSelector) {
            let listHtml = sortedMembers.slice(0, 5).map((member, index) => `<li class="flex justify-between items-center py-2 ${index < 4 ? 'border-b border-gray-700' : ''}"><span class="text-sm text-gray-300">${index + 1}. ${member.Name}</span><span class="font-semibold text-white">${formatFame(valueSelector(member) || 0)}</span></li>`).join('');
            document.getElementById(elementId).innerHTML = `<h3 class="text-lg font-bold text-red-400 mb-4">${title}</h3><ul class="space-y-1">${listHtml}</ul>`;
        }
        function displayMembers(members) {
            members.sort((a, b) => b.KillFame - a.KillFame);
            memberListBody.innerHTML = members.map(member => `<tr class="hover:bg-gray-700/50 transition-colors duration-200 cursor-pointer" onclick="showPlayerProfile('${member.Id}')"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${member.Name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-400 font-semibold">${formatFame(member.KillFame)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatFame(member.DeathFame)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatFame(member.LifetimeStatistics.PvE.Total || 0)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatFame(member.LifetimeStatistics.Gathering.All.Total || 0)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatFame(member.LifetimeStatistics.Crafting.Total || 0)}</td></tr>`).join('');
        }
        function displayBattleList(battles) {
            if (battles.length === 0) {
                battlesListContainer.innerHTML = '<p class="text-center text-gray-400">Filtreye uygun savaÅŸ bulunamadÄ±.</p>'; return;
            }
            battlesListContainer.innerHTML = battles.map(battle => {
                const winner = Object.values(battle.guilds).sort((a, b) => b.killFame - a.killFame)[0];
                const isWinner = winner.id === GUILD_ID;
                const battleTime = new Date(battle.startTime).toLocaleTimeString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                return `<div class="bg-gray-900/70 p-3 rounded-lg border-l-4 ${isWinner ? 'border-green-500' : 'border-red-500'} cursor-pointer hover:bg-gray-700" onclick="showBattleReport('${battle.id}')">
                            <p class="font-bold">${Object.values(battle.guilds).map(g => g.name).join(' vs ')}</p>
                            <p class="text-xs text-gray-400">${battle.totalPlayers} KatÄ±lÄ±mcÄ± | ${battleTime}</p>
                        </div>`;
            }).join('');
        }
        function applyBattleFilter() {
            const minPlayers = parseInt(battleFilterInput.value, 10) || 0;
            const filteredBattles = allGuildBattles.filter(b => b.totalPlayers >= minPlayers);
            displayBattleList(filteredBattles);
        }
        function showStatus(message, type) {
            loader.style.display = 'none';
            statusMessage.textContent = '';
            if (type === 'loading') {
                loader.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = 'text-gray-400';
            } else if (type === 'error') {
                statusMessage.textContent = message;
                statusMessage.className = 'text-red-400 font-semibold';
            }
        }
        function displayTrackingDashboard(members, battles) {
            const riskyPlayers = new Map();
            battles.forEach(battle => {
                if (battle.players) {
                    Object.values(battle.players).forEach(player => {
                        if (player.guildId === GUILD_ID && player.deaths > 0) {
                            if (!riskyPlayers.has(player.name)) {
                                riskyPlayers.set(player.name, { name: player.name, deathCount: 0 });
                            }
                            riskyPlayers.get(player.name).deathCount += player.deaths;
                        }
                    });
                }
            });
            const sortedRisky = [...riskyPlayers.values()].sort((a, b) => b.deathCount - a.deathCount);
            if (sortedRisky.length > 0) {
                riskyListContainer.innerHTML = `<ul class="space-y-2">${sortedRisky.map(p => `<li class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md text-sm"><span class="font-medium text-white">${p.name}</span><span class="font-semibold text-orange-400">${p.deathCount} Ã¶lÃ¼m</span></li>`).join('')}</ul>`;
            } else {
                riskyListContainer.innerHTML = '<p class="text-center text-gray-400">Riskli oyuncu bulunamadÄ±.</p>';
            }
        }
        async function startInactiveAnalysis() {
            inactiveCheckBtn.disabled = true;
            inactiveListContainer.innerHTML = '<div class="flex flex-col items-center gap-2"><div class="loader"></div><p class="text-sm text-gray-400">Oyuncular analiz ediliyor... Bu iÅŸlem birkaÃ§ dakika sÃ¼rebilir.</p></div>';
            const inactivePlayers = [];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            for (const member of guildMembersData) {
                try {
                    const [kills, deaths] = await Promise.all([
                        fetchApi(`/players/${member.Id}/kills?limit=1`),
                        fetchApi(`/players/${member.Id}/deaths?limit=1`)
                    ]);
                    const lastKillTime = kills.length > 0 ? new Date(kills[0].TimeStamp) : new Date(0);
                    const lastDeathTime = deaths.length > 0 ? new Date(deaths[0].TimeStamp) : new Date(0);
                    const lastActivity = Math.max(lastKillTime, lastDeathTime);
                    if (new Date(lastActivity) < sevenDaysAgo) {
                        inactivePlayers.push({ name: member.Name, lastActivity: new Date(lastActivity) });
                    }
                    await sleep(300); 
                } catch (error) {
                    console.error(`${member.Name} iÃ§in aktivite kontrolÃ¼ baÅŸarÄ±sÄ±z:`, error);
                }
            }
            if (inactivePlayers.length > 0) {
                inactiveListContainer.innerHTML = `<ul class="space-y-2 alert-list max-h-80 overflow-y-auto">${inactivePlayers.map(p => `<li class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md text-sm"><span class="font-medium text-white">${p.name}</span><span class="text-xs text-gray-400">Son aktivite: ${p.lastActivity.getFullYear() < 2000 ? 'Bilinmiyor' : p.lastActivity.toLocaleDateString('tr-TR')}</span></li>`).join('')}</ul>`;
            } else {
                inactiveListContainer.innerHTML = '<p class="text-center text-gray-400">Ä°naktif oyuncu bulunamadÄ±.</p>';
            }
            inactiveCheckBtn.disabled = false;
        }
        function setupCompositionBuilder() {
            const roleSidebar = document.getElementById('role-sidebar');
            const compGrid1 = document.getElementById('composition-grid-1');
            const compGrid2 = document.getElementById('composition-grid-2');
            const progressBar = document.getElementById('comp-progress-bar');

            if (!roleSidebar || !compGrid1 || !compGrid2) return;
            if (compositionBuilderInitialized) return;
            compositionBuilderInitialized = true;

            const roles = {
                'DEF': { color: 'bg-blue-600', textColor: 'text-white', builds: ['CALLER', 'GA KNIGHT', 'GA DUSK', 'BEDROCK', 'CLUMPER', '1H ARCANE', 'INCUBUS', 'HEAVY MACE', '1H HAMMER', 'HOARFROST / ICICLE'] },
                'SUPPORT': { color: 'bg-yellow-500', textColor: 'text-black', builds: ['LIFE CURSE', 'ROOTBOUND', 'OCCULT', 'LOCUS'] },
                'HEALER': { color: 'bg-green-500', textColor: 'text-white', builds: ['HALLOWFALL DRUID', 'HALLOWFALL CLEANSE', 'OATHKEEPERS', 'RAMPANT / BLIGHT', 'HALLOWFALL', 'EXALTED / RAMPANT'] },
                'DPS': { color: 'bg-red-600', textColor: 'text-white', builds: ['DAMNATION / SPIRIT', 'REALMBREAKER', 'CARVING', 'PERMA MAIN', 'PERMA SECOND', 'SPIKED', 'RIFT', 'FORGEBARK', 'SPIRITHUNTER', 'RIFT / WAILING', 'ROTCALLER', 'DAWNSONG', 'WITCHWORK'] }
            };

            roleSidebar.innerHTML = Object.entries(roles).map(([category, data]) => `
                <div>
                    <h4 class="font-bold text-lg mb-2 text-white">${category}</h4>
                    <div class="space-y-2" id="role-list-${category.toLowerCase()}">
                        ${data.builds.map(build => `
                            <div class="role-item ${data.color} ${data.textColor}" draggable="true" data-role='${JSON.stringify({ name: build, category: category, color: data.color, textColor: data.textColor })}'>
                                ${build}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3">
                        <input type="text" id="new-role-input-${category.toLowerCase()}" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-1 text-sm" placeholder="Yeni rol ekle...">
                        <button id="add-role-btn-${category.toLowerCase()}" class="w-full mt-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-2 rounded-md transition">Ekle</button>
                    </div>
                </div>
            `).join('');

            compGrid1.innerHTML = Array(20).fill('<div class="comp-grid-cell rounded-md"></div>').join('');
            compGrid2.innerHTML = Array(20).fill('<div class="comp-grid-cell rounded-md"></div>').join('');
            
            function addRoleItem(roleData, category) {
                const roleList = document.getElementById(`role-list-${category.toLowerCase()}`);
                const roleDiv = document.createElement('div');
                roleDiv.className = `role-item ${roleData.color} ${roleData.textColor}`;
                roleDiv.draggable = true;
                roleDiv.dataset.role = JSON.stringify(roleData);
                roleDiv.textContent = roleData.name;
                roleDiv.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.role);
                });
                roleList.appendChild(roleDiv);
            }

            Object.entries(roles).forEach(([category, data]) => {
                const input = document.getElementById(`new-role-input-${category.toLowerCase()}`);
                const button = document.getElementById(`add-role-btn-${category.toLowerCase()}`);
                button.addEventListener('click', () => {
                    const newRoleName = input.value.trim();
                    if(newRoleName) {
                        addRoleItem({ name: newRoleName, category: category, color: data.color, textColor: data.textColor }, category);
                        input.value = '';
                    }
                });
            });


            document.querySelectorAll('.role-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.role);
                });
            });

            const allCells = [...compGrid1.querySelectorAll('.comp-grid-cell'), ...compGrid2.querySelectorAll('.comp-grid-cell')];
            allCells.forEach(cell => {
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    cell.classList.add('drag-over');
                });
                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('drag-over');
                });
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    const roleData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (cell.innerHTML === '') {
                        cell.textContent = roleData.name;
                        cell.className = `comp-grid-cell rounded-md flex items-center justify-center ${roleData.color} ${roleData.textColor}`;
                        cell.dataset.roleCategory = roleData.category;
                        cell.addEventListener('dblclick', () => {
                            cell.innerHTML = '';
                            cell.className = 'comp-grid-cell rounded-md';
                            delete cell.dataset.roleCategory;
                            updateProgressBar();
                        });
                        updateProgressBar();
                    }
                });
            });
            
            function updateProgressBar() {
                const counts = { DEF: 0, SUPPORT: 0, HEALER: 0, DPS: 0 };
                let total = 0;
                allCells.forEach(cell => {
                    if (cell.dataset.roleCategory) {
                        counts[cell.dataset.roleCategory]++;
                        total++;
                    }
                });
                
                if (total === 0) {
                    progressBar.innerHTML = '';
                    return;
                }

                const colors = { DEF: 'bg-blue-600', SUPPORT: 'bg-yellow-500', HEALER: 'bg-green-500', DPS: 'bg-red-600' };
                progressBar.innerHTML = Object.entries(counts).map(([category, count]) => {
                    const percentage = (count / total) * 100;
                    if (percentage === 0) return '';
                    return `<div class="${colors[category]}" style="width: ${percentage}%">${Math.round(percentage)}%</div>`;
                }).join('');
            }
        }
        
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            searchResultsContainer.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
            
            try {
                const response = await fetchApi(`/search?q=${encodeURIComponent(query)}`);
                let html = '<div><h3 class="text-xl font-bold text-red-400 mb-4">Guild SonuÃ§larÄ±</h3>';
                if (response.guilds && response.guilds.length > 0) {
                    html += '<ul class="space-y-3">';
                    response.guilds.forEach(guild => {
                        html += `<li class="p-3 bg-gray-800 rounded-lg">
                                    <p class="font-bold text-lg">${guild.Name} <span class="text-gray-400">[${guild.AllianceTag || 'N/A'}]</span></p>
                                    <p class="text-sm text-gray-400">Kill Fame: ${formatFame(guild.KillFame)} | ${guild.MemberCount} Ãœye</p>
                                 </li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p class="text-gray-400">Guild bulunamadÄ±.</p>';
                }
                html += '</div>';

                html += '<div class="mt-8"><h3 class="text-xl font-bold text-red-400 mb-4">Oyuncu SonuÃ§larÄ±</h3>';
                if (response.players && response.players.length > 0) {
                    html += '<ul class="space-y-3">';
                    response.players.forEach(player => {
                        html += `<li class="p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="showPlayerProfile('${player.Id}')">
                                    <p class="font-bold text-lg">${player.Name} <span class="text-gray-400">[${player.GuildName || 'Guild Yok'}]</span></p>
                                    <p class="text-sm text-gray-400">Kill Fame: ${formatFame(player.KillFame)}</p>
                                 </li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p class="text-gray-400">Oyuncu bulunamadÄ±.</p>';
                }
                html += '</div>';
                
                searchResultsContainer.innerHTML = html;

            } catch (error) {
                console.error("Arama hatasÄ±:", error);
                searchResultsContainer.innerHTML = '<p class="text-red-400 text-center">Arama sÄ±rasÄ±nda bir hata oluÅŸtu.</p>';
            }
        }
    </script>
</body>
</html>
